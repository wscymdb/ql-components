## 运行机制与生命周期

了解 Upload SDK 的内部执行流程，有助于您更好地利用生命周期钩子（Hooks）来定制业务逻辑。

SDK 采用 **双线程架构**：

-   **主线程 (Main Thread)**：负责配置管理、UI 交互、以及执行您编写的 Hooks（业务逻辑）。
-   **Worker 线程**：负责繁重的 Hash 计算、文件切片、以及高频的并发网络请求。

### 核心流程图

下图展示了从调用 `startUpload` 到任务结束的完整时机与交互流程：

<code src="./index.tsx" ></code>

### 阶段详解

#### 1. 启动与计算 (Start & Hash)

-   SDK 将文件引用传递给 Worker（零拷贝）。
-   Worker 使用 `hash-wasm` 进行流式 Hash 计算。
-   **注意**：此阶段完全在 Worker 中进行，不会阻塞 UI。

#### 2. 初始化 (Init)

-   **触发时机**：Hash 计算完成后。
-   **作用**：您可以在此钩子中将 `ctx.hash` 发送给后端，申请 `uploadId` 或进行预检查。
-   **数据流**：`init` 钩子的返回值会被存储在 `ctx.initData` 中，供后续所有阶段使用。

#### 3. 并发上传 (Upload)

-   **触发时机**：如果有 init hook ，则在 init hook 执行完毕后，否则 Hash 计算完成后。
-   **并发控制**：Worker 内部维护一个请求池，并发数由 `config.concurrency` 控制（默认 3）。
-   **验证机制**：每次分片上传成功后，都会回调 `validateResponse`。如果此时抛出错误（如空间不足、Token 过期），整个任务将**立即终止**并抛出异常。

#### 4. 合并 (Merge)

-   **触发时机**：所有分片上传完毕后。
-   **作用**：通知后端进行文件合并。这是上传流程的最后一步。
