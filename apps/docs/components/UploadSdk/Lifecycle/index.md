# 运行机制与生命周期

Upload SDK 采用 **Off-Main-Thread (脱离主线程)** 架构。所有的计算密集型（Hash）和 I/O 密集型（网络请求）任务均在 Web Worker 中执行，主线程仅通过 RPC 钩子控制业务逻辑。

下图展示了从调用 `startUpload` 到任务结束的完整数据流向。
<code src="./index.tsx" ></code>

## 核心流程图

## 阶段详解

### 1. 计算阶段 (Calculating)

- **执行者**: Worker 线程。
- **行为**: 使用 `hash-wasm` 对大文件进行流式读取和 SHA-256 计算。
- **优化**: 支持 `preCalculate()` 预计算。

### 2. 初始化 (Init)

- **执行者**: **主线程** (用户 Hook)。
- **秒传实现**: 在此阶段，您可以请求后端检查文件 Hash 是否已存在。如果存在，直接调用 `ctx.success(data)`，SDK 将跳过后续所有步骤，直接判定为成功。

### 3. 上传 (Upload)

- **执行者**: Worker 线程。
- **行为**: Worker 询问主线程获取上传配置，然后并发上传所有切片。
- **注意**: 默认配置下，SDK 会跳过 `Check` (断点续传检测) 阶段，直接开始上传所有切片。

### 4. 合并 (Merge)

- **执行者**: Worker 线程。
- **行为**: 所有切片发送完毕后触发，通知后端合并文件。
